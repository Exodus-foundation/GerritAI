<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GerritAI Coding Agent</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for the output area */
        #outputArea::-webkit-scrollbar {
            width: 8px;
            border-radius: 4px;
        }
        #outputArea::-webkit-scrollbar-track {
            background: #e0f2fe; /* Light blue track */
        }
        #outputArea::-webkit-scrollbar-thumb {
            background: #90cdf4; /* Medium blue thumb */
            border-radius: 4px;
        }
        #outputArea::-webkit-scrollbar-thumb:hover {
            background: #63b3ed; /* Darker blue on hover */
        }
        /* Custom font */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #e0f2fe, #ffffff); /* Light blue to white gradient */
        }
        /* Style for the button hover/active state */
        #generateButton:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        }
        #generateButton:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* Glass effect for text (requires backdrop-filter support) */
        .glass-text {
            /* Fallback for browsers that don't support backdrop-filter */
            color: #1a202c; /* Dark text for readability */
            /* Modern browser glass effect */
            background: rgba(255, 255, 255, 0.2); /* Slightly visible background */
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            padding: 2px 8px; /* Add some padding to make the effect visible */
            border-radius: 5px;
            display: inline-block; /* Essential for padding and blur to work on text */
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3); /* Subtle white shadow for depth */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Light border */
        }

        /* Glow effect for text */
        .glow-text {
            text-shadow:
                0 0 5px rgba(66, 153, 225, 0.6), /* Blue glow */
                0 0 10px rgba(66, 153, 225, 0.4),
                0 0 15px rgba(66, 153, 225, 0.2);
        }

        /* Combined effect for title (general glow) */
        .title-effect {
            text-shadow:
                0 0 8px rgba(37, 99, 235, 0.7), /* Stronger blue glow */
                0 0 15px rgba(37, 99, 235, 0.5);
        }
        /* Specific glow for "AI" part */
        .title-effect .highlight-ai {
            text-shadow:
                0 0 8px rgba(255, 140, 0, 0.7), /* Orange glow for AI */
                0 0 15px rgba(255, 140, 0, 0.5);
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <div class="w-full max-w-5xl bg-white shadow-xl rounded-xl p-6 md:p-10 transition-all duration-300 border border-blue-200">
        <div class="flex flex-col items-center mb-6">
            <!-- Logo removed from here --><h1 class="text-3xl sm:text-4xl font-extrabold mb-2 text-center title-effect">
                <span class="text-blue-600">Gerrit</span><span class="text-orange-500 highlight-ai">AI</span>
            </h1>
        </div>
        <p class="text-gray-600 text-center mb-6">
            Describe the code you want (e.g., "Write a Python script for a quicksort algorithm").
        </p>
        
        <!-- Model Selection Dropdown --><div class="mb-6">
            <label for="modelSelector" class="block text-sm font-medium text-gray-700 mb-2">Select AI Model:</label>
            <select id="modelSelector"
                class="w-full p-3 text-gray-800 bg-blue-50 border border-blue-200 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors"
            >
                <option value="gemini-2.5-flash-preview-09-2025" selected>Google AI (Gemini 2.5 Flash)</option>
                <option value="unsupported-gpt5">(Unsupported) GPT-5 - Requires external API key</option>
            </select>
        </div>

        <!-- API Key Input (Hidden by default) --><div id="apiKeyInputGroup" class="mb-6 hidden">
            <label for="apiKeyInput" class="block text-sm font-medium text-gray-700 mb-2">OpenAI API Key (sk-...):</label>
            <input type="password" id="apiKeyInput"
                class="w-full p-3 text-gray-800 bg-red-50 border border-red-200 rounded-lg focus:ring-red-500 focus:border-red-500 transition-colors placeholder-gray-500"
                placeholder="Enter your sk- key here to attempt using GPT-5"
            />
            <p class="mt-2 text-xs text-red-600">Warning: GPT-5 API calls are blocked in this environment, but the key is required for activation.</p>
        </div>

        <!-- Input Area --><div class="mb-6">
            <textarea id="promptInput" rows="4"
                class="w-full p-4 text-gray-800 bg-blue-50 border border-blue-200 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors placeholder-gray-500"
                placeholder="Enter your coding request here..."
            ></textarea>
        </div>

        <!-- Action Button --><div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-4">
            <button id="generateButton"
                class="w-full sm:w-auto px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition duration-150 ease-in-out flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                onclick="handleGenerateCode()"
            >
                <span id="buttonText">Generate Code</span>
                <div id="loadingSpinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white ml-2"></div>
            </button>

            <button id="copyButton"
                class="w-full sm:w-auto px-6 py-3 bg-gray-400 text-gray-800 font-semibold rounded-lg shadow-lg hover:bg-gray-500 hover:text-white transition duration-150 ease-in-out flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                onclick="copyCode()" disabled
            >
                Copy to Clipboard
            </button>
        </div>

        <!-- Output Area --><div class="mt-8">
            <h2 class="text-xl font-semibold text-blue-700 mb-3 glow-text glass-text">Generated Code:</h2>
            <pre id="outputArea"
                class="relative p-4 md:p-6 bg-blue-50 text-blue-900 rounded-lg border border-blue-200 text-sm overflow-auto max-h-96 whitespace-pre-wrap"
            ><code id="codeContent" class="language-plaintext">The generated code will appear here.</code></pre>

             <!-- Notification Message --><div id="notification" class="mt-4 p-3 rounded-lg text-center hidden" role="alert"></div>
        </div>
    </div>

    <script>
        // --- Firebase Globals (Required but not used for this single-user API app) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --------------------------------------------------------------------------

        const API_URL_BASE = 'https://generativelanguage.googleapis.com/v1beta/models/';
        // NOTE: Using the API key provided by the user.
        const apiKey = "AIzaSyDOsTPa-F2pAVlS8SRbSc-2pY1u2riH40g";

        const promptInput = document.getElementById('promptInput');
        const generateButton = document.getElementById('generateButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const outputArea = document.getElementById('outputArea');
        const codeContent = document.getElementById('codeContent');
        const copyButton = document.getElementById('copyButton');
        const notification = document.getElementById('notification');
        const modelSelector = document.getElementById('modelSelector');
        
        // New elements for API key input
        const apiKeyInputGroup = document.getElementById('apiKeyInputGroup');
        const apiKeyInput = document.getElementById('apiKeyInput');

        // Sets the system instruction to guide the LLM to output only code.
        const systemInstruction = {
            parts: [{
                text: "You are an expert coding assistant specializing in generating complete, clean, and well-commented code. For the user's request, you must respond ONLY with a single, complete code block using the appropriate language markdown identifier (e.g., ```python, ```javascript, ```html). Do not include any conversational text, explanations, or titles outside of the code block. Your output must be nothing more than the markdown-formatted code block."
            }]
        };

        /**
         * Utility function to display temporary messages (like copy success/failure).
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error'.
         */
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = 'mt-4 p-3 rounded-lg text-center';
            if (type === 'success') {
                notification.classList.add('bg-green-200', 'text-green-800');
            } else if (type === 'error') {
                notification.classList.add('bg-red-200', 'text-red-800');
            } else if (type === 'warning') {
                notification.classList.add('bg-yellow-200', 'text-yellow-800');
            }
            notification.classList.remove('hidden');

            setTimeout(() => {
                notification.classList.add('hidden');
            }, 4000);
        }

        /**
         * Toggles the visibility of the API key input based on the selected model.
         */
        modelSelector.addEventListener('change', () => {
            if (modelSelector.value === 'unsupported-gpt5') {
                apiKeyInputGroup.classList.remove('hidden');
                showNotification("Please enter your OpenAI API key to attempt using GPT-5.", 'warning');
            } else {
                apiKeyInputGroup.classList.add('hidden');
            }
        });


        /**
         * Copies the content of the code output area to the clipboard.
         */
        function copyCode() {
            const textToCopy = codeContent.textContent;
            if (!textToCopy || textToCopy.trim() === 'The generated code will appear here.') {
                 showNotification("No code to copy yet.", 'error');
                return;
            }

            // Fallback for secure context issues in iframes
            if (document.execCommand('copy')) {
                const textarea = document.createElement('textarea');
                textarea.value = textToCopy;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification("Code copied to clipboard!", 'success');
            } else {
                showNotification("Copy failed. Please select and copy manually.", 'error');
            }
        }

        /**
         * Calls the Gemini API with exponential backoff.
         * @param {object} payload - The request payload.
         * @param {string} modelName - The model to use for the API call.
         * @param {number} maxRetries - Maximum number of retries.
         * @param {number} delay - Initial delay in milliseconds.
         * @returns {Promise<object>} The JSON response from the API.
         */
        async function fetchWithBackoff(payload, modelName, maxRetries = 5, delay = 1000) {
            const url = `${API_URL_BASE}${modelName}:generateContent?key=${AIzaSyDOsTPa-F2pAVlS8SRbSc-2pY1u2riH40g}`;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    }

                    // Handle rate limiting (429) and other temporary errors
                    if (response.status === 429 || response.status >= 500) {
                        if (attempt < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Exponential increase
                            continue; // Retry
                        }
                    }

                    // For non-retryable errors (e.g., 400, 401, 403)
                    const errorJson = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorJson.error.message}`);

                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        throw error; // Re-throw if it was the last attempt
                    }
                    // Wait and retry for network errors
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
            // Should be unreachable, but good for completeness
            throw new Error("Maximum retries reached without a successful response.");
        }

        /**
         * Main function to handle the code generation process.
         */
        async function handleGenerateCode() {
            const userPrompt = promptInput.value.trim();
            const selectedModel = modelSelector.value;

            if (!userPrompt) {
                showNotification("Please enter a coding request.", 'error');
                return;
            }
            
            // Check if the selected model is unsupported
            if (selectedModel === 'unsupported-gpt5') {
                const userApiKey = apiKeyInput.value.trim();
                if (!userApiKey) {
                    showNotification("Please enter your OpenAI API key to proceed with GPT-5.", 'error');
                    return;
                }
                
                // Warn the user that the API call is blocked, even with a key
                codeContent.textContent = `--- BLOCKED API CALL ---\nGPT-5 is selected and key is provided. However, calls to external (non-Gemini) APIs are blocked in this secure execution environment. Please select 'Google AI' instead.`;
                showNotification("GPT-5 is blocked. Select 'Google AI'.", 'error');
                return;
            }


            // UI State: Disable button, show spinner, clear output
            generateButton.disabled = true;
            copyButton.disabled = true;
            buttonText.textContent = 'Generating...';
            loadingSpinner.classList.remove('hidden');
            codeContent.textContent = '';
            outputArea.classList.add('animate-pulse'); // Add visual feedback

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: systemInstruction,
            };

            try {
                const result = await fetchWithBackoff(payload, selectedModel); // Pass selectedModel

                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text ||
                                     'Error: Could not extract generated text from the response.';

                // The text should contain the code block, but we display the whole response.
                codeContent.textContent = generatedText;
                copyButton.disabled = false;
                outputArea.scrollTo(0, 0); // Scroll to top of output
                showNotification("Code generated successfully!", 'success');

            } catch (error) {
                console.error("Code Generation Failed:", error);
                codeContent.textContent = `--- ERROR ---\n${error.message}\n\nPlease check the console for details or try again.`;
                showNotification("An API error occurred. Check console for details.", 'error');

            } finally {
                // UI State: Re-enable button, hide spinner
                generateButton.disabled = false;
                buttonText.textContent = 'Generate Code';
                loadingSpinner.classList.add('hidden');
                outputArea.classList.remove('animate-pulse');
            }
        }
    </script>
</body>
</html>
